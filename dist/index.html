<html>
<head>
<script src='https://unpkg.com/jquery@3.3.1/dist/jquery.min.js'></script>
<script src="https://unpkg.com/ramda@0.25.0/dist/ramda.min.js"></script>

<script src='https://unpkg.com/leaflet@1.3.1/dist/leaflet.js'></script>
<link rel='stylesheet' href='https://unpkg.com/leaflet@1.3.1/dist/leaflet.css' />

<script src='https://unpkg.com/leaflet.markercluster@1.3.0/dist/leaflet.markercluster.js'></script>
<script src='assets/leaflet-markercluster.placementstrategies.js'></script>
<link rel='stylesheet' href='https://unpkg.com/leaflet.markercluster@1.3.0/dist/MarkerCluster.Default.css' />
<link rel='stylesheet' href='https://unpkg.com/leaflet.markercluster@1.3.0/dist/MarkerCluster.css' />

<script>
var bps = [];
var myMap = null;
var myMarkers = null;
	
function initMap() {
	myMap = L.map('map');
	myMap.fitWorld().zoomIn();
		
	var CartoDB_Positron = L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}{r}.png', {
		//attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
		subdomains: 'abcd',
		maxZoom: 19
	});
	
	CartoDB_Positron.addTo(myMap);

	//myMap.attributionControl.setPrefix(false);
	myMarkers = L.markerClusterGroup({
		maxClusterRadius: 10,
		spiderLegPolylineOptions: {weight: 0},
		//clockHelpingCircleOptions: {weight: 1.7, opacity: 1, color: 'black', fillOpacity: 0, dashArray: '10 5'},

		elementsPlacementStrategy: 'concentric',
		helpingCircles: true,
		helpingCircleOptions: { fillOpacity: 0, color: 'black', weight: 0.6 },

		//spiderfyDistanceSurplus: 25,
		//spiderfyDistanceMultiplier: 10,

		//elementsMultiplier: 1.4,
		firstCircleElements: 8
	});
	myMap.addLayer(myMarkers);

	$.get("/api/producers", function(data) {
		bps = data;
		processBPs();
	});
}
	
function processBPs(){

	for (var i = 0; i < bps.length; i++) {
		var bp = bps[i];
		var rank = i+1;

		if (!bp.bp_json) continue;

		for(var j = 0; j < bp.bp_json.nodes.length; j++) {
			var node = bp.bp_json.nodes[j];
			
			if(
				node.p2p_loc && node.api_loc && (
					(node.p2p_loc.ip == node.api_loc.ip) || 
					((node.p2p_loc.latitude == node.api_loc.latitude) && (node.p2p_loc.longitude == node.api_loc.longitude))
				)
			) {
				//single marker
				createMarker(bp.bp_json, {api: node.api_endpoint, p2p: node.p2p_endpoint}, node.api_loc, rank);
			} else if(node.p2p_loc) {
				createMarker(bp.bp_json, {p2p: node.p2p_endpoint}, node.p2p_loc, rank);
			} else if(node.api_loc) {
				createMarker(bp.bp_json, {api: node.api_endpoint}, node.api_loc, rank);
			}
		}
	}
}

function createMarker(bp_json, endpoints, loc, rank) {
	
	var icon = L.icon({
		iconUrl: 'assets/eos-logo.png',
		iconSize:     [36, 36], // size of the icon
    	iconAnchor:   [18, 18], // point of the icon which will correspond to marker's location
	   	tooltipAnchor:  [0, 0] // point from which the popup should open relative to the iconAnchor
	});
	
	var marker = L.marker([loc.latitude, loc.longitude], {icon: icon});
	
	var img = "/assets/eos-logo.png";
	if(bp_json.org.branding && bp_json.org.branding.logo_256) {
		img = bp_json.org.branding.logo_256;
	}

	var popup = '<h2>' + bp_json.org.candidate_name + ' (' + rank.toString() + ')</h2>' +
				 '<img style="max-height: 50;" src="' + img + '"></img><br />';

	var endpointHtml = '<b>{0}' + '</b> (' + loc.ip + ')';
	
	if(endpoints.api) {
		popup += `<b>API: ${endpoints.api}</b> (${loc.ip})<br />`;
	}

	if(endpoints.p2p) {
		popup += `<b>P2P: ${endpoints.p2p}</b> (${loc.ip})<br />`;
	}

	popup += `<span>${loc.city}, ${loc.country_name}</span>`;

	marker.bindPopup(popup, {className: 'popupFoo'});
	marker.on('mouseover', function(event){
		marker.openPopup();
	});

	//marker.on('mouseout', function(event){
	//	marker.closePopup();
	//});

	myMarkers.addLayer(marker);
}


</script>

<style>
body {
	padding: 0;
	margin: 0;
}
#map {
	height: 100%;
	width: 100%;
}
</style>
</head>

<body onload='initMap()'>
	<div id='map'></div>
</body>

</html>