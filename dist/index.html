<html>
<head>
<script src='https://unpkg.com/jquery@3.3.1/dist/jquery.min.js'></script>
<script src="https://unpkg.com/ramda@0.25.0/dist/ramda.min.js"></script>

<script src='https://unpkg.com/leaflet@1.3.1/dist/leaflet.js'></script>
<link rel='stylesheet' href='https://unpkg.com/leaflet@1.3.1/dist/leaflet.css' />

<script src='https://unpkg.com/leaflet.markercluster@1.3.0/dist/leaflet.markercluster.js'></script>
<link rel='stylesheet' href='https://unpkg.com/leaflet.markercluster@1.3.0/dist/MarkerCluster.Default.css' />
<link rel='stylesheet' href='https://unpkg.com/leaflet.markercluster@1.3.0/dist/MarkerCluster.css' />

<script>
var bps = [];
var myMap = null;
var myMarkers = null;
var apiMarkers = [];
var p2pMarkers = [];
var totalGets = 0;
var currentLayers = "p2p";
	
function initMap() {
	myMap = L.map('map');
	myMap.fitWorld().zoomIn();
		
	var CartoDB_Positron = L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}{r}.png', {
		//attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
		subdomains: 'abcd',
		maxZoom: 19
	});
	
	CartoDB_Positron.addTo(myMap);

	//myMap.attributionControl.setPrefix(false);
	myMarkers = L.markerClusterGroup({
		maxClusterRadius: 10
	});
	myMap.addLayer(myMarkers);

	$.get("/api/producers", function(data) {
		bps = data;
		processBPs();
		addMarkersToMap();
	});
}
	
function processBPs(){

	for (var i in bps) {
		var bp = bps[i];

		for(var j in bp.bp_json.nodes) {
			var node = bp.bp_json.nodes[j];
			if(node.p2p_loc && node.p2p_loc.latitude) {
				createMarker(bp, node.p2p_loc, 'p2p');
			}
			if(node.api_loc && node.api_loc.latitude) {
				createMarker(bp, node.api_loc, 'api');
			}
		}
	}
}

function createMarker(bp, loc, type) {
	
	var marker = L.marker([loc.latitude, loc.longitude]);
	marker.bindTooltip(bp.bp_json.org.candidate_name + ' :: ' + type);

	var img = "http://www.troublefixers.com/wp-content/uploads/2013/03/Broken-Image.png";
	if(bp.bp_json.org.branding && bp.bp_json.org.branding.logo_256) {
		img = bp.bp_json.org.branding.logo_256;
	}
	var popup = '<h1>' + bp.bp_json.org.candidate_name + '</h1>' +
				'<img style="height: 50; width: 50;" src="' + img + '"></img><br />' + 
				'<span>' + loc.isp + '</span>';

	marker.bindPopup(popup);
	
	if(type === 'p2p') {
		p2pMarkers.push(marker);
	} else {
		apiMarkers.push(marker);
	}	
}

function addMarkersToMap() {
	if(currentLayers === 'p2p') {

		for(var i = 0; i < apiMarkers.length; i++) {
			myMarkers.addLayer(apiMarkers[i]);
		}
		currentLayers = "api";
	} else {
		for(var i = 0; i < p2pMarkers.length; i++) {
			myMarkers.addLayer(p2pMarkers[i]);
		}
		currentLayers = "p2p";
	}
}

$(document).keypress(function(e) {
  if(e.which == 13) {
    // enter pressed
    myMarkers.clearLayers();

    addMarkersToMap();
  }
});


</script>

<style>
body {
	padding: 0;
	margin: 0;
}
#map {
	height: 100%;
	width: 100%;
}
</style>
</head>

<body onload='initMap()'>
	<div id='map'></div>
</body>

</html>